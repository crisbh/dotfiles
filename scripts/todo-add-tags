#!/opt/homebrew/bin/bash  # Apple Silicon (M1/M2)

TODO_FILE="$VAULT/0-inbox/todo.md"
TAG_CONFIG="$HOME/.dotfiles/scripts/task-tags.conf"
TEMP_FILE="/tmp/tagged_tasks.txt"

# Load keyword → tag mappings from external file
declare -A TAG_MAP
while IFS=":" read -r tag pattern; do
    [[ -z "$tag" || "$tag" =~ ^# ]] && continue  # Skip empty lines & comments
    TAG_MAP["$tag"]="$pattern"
done < "$TAG_CONFIG"

# Read and preserve the YAML header of the TODO.md file
HEADER_LINES=()
TASKS_FOUND=false
while IFS= read -r LINE; do
    if [[ "$LINE" == "---" && ${#HEADER_LINES[@]} -eq 0 ]]; then
        HEADER_LINES+=("$LINE")
    elif [[ ${#HEADER_LINES[@]} -gt 0 && "$LINE" != "---" ]]; then
        HEADER_LINES+=("$LINE")
    elif [[ "$LINE" == "---" && ${#HEADER_LINES[@]} -gt 0 ]]; then
        HEADER_LINES+=("$LINE")
        HEADER_LINES+=("")
        break
    else
        break
    fi
done < "$TODO_FILE"

# Write the preserved header to the temp file
printf "%s\n" "${HEADER_LINES[@]}" > "$TEMP_FILE"

# Find and keep the "# TODO list" title
while IFS= read -r LINE; do
    if [[ "$LINE" == "# TODO list" ]]; then
        echo "$LINE" >> "$TEMP_FILE"
        break
    fi
done < "$TODO_FILE"

# Process each task and append the correct tags
while IFS= read -r LINE; do
    [[ -z "$LINE" ]] && echo "" >> "$TEMP_FILE" && continue

    if [[ "$LINE" =~ ^- ]]; then
        TASKS_FOUND=true
        TASK_TEXT=$(echo "$LINE" | sed -E 's/- \[[! ]\] //')  # Remove checkboxes
        TASK_TEXT_LOWER=$(echo "$TASK_TEXT" | tr '[:upper:]' '[:lower:]')  # Normalize to lowercase
        declare -A TAGS_ARRAY

        echo "🔍 Processing task: $TASK_TEXT"

        # Check the task text against all regex patterns
        for tag in "${!TAG_MAP[@]}"; do
            pattern="${TAG_MAP[$tag]}"
            pattern_lower=$(echo "$pattern" | tr '[:upper:]' '[:lower:]')  # Normalize pattern to lowercase
            
            # echo "🔍 Checking pattern '$pattern_lower' for tag '$tag'..."
            
            if [[ $TASK_TEXT_LOWER =~ $pattern_lower ]]; then  
                echo "✅ Match found! Adding tag '$tag' to task '$TASK_TEXT'"
                TAGS_ARRAY["$tag"]=1
            fi
        done

        # Convert array keys to a space-separated list
        TAGS=$(echo "${!TAGS_ARRAY[@]}" | tr ' ' ' ')

        # Append tags if they don't already exist
        if [[ -n "$TAGS" ]]; then
            echo "$LINE $TAGS" >> "$TEMP_FILE"
        else
            echo "$LINE" >> "$TEMP_FILE"
        fi
    else
        echo "$LINE" >> "$TEMP_FILE"
    fi
done < <(awk 'f;/^# TODO list/{f=1}' "$TODO_FILE")

# Replace the original TODO file if tasks were found
if $TASKS_FOUND; then
    mv "$TEMP_FILE" "$TODO_FILE"
    echo "✅ Tasks updated with multiple tags in $TODO_FILE"
else
    echo "❌ No tasks found to update!"
fi

